name: Free RDP with Bore

on: workflow_dispatch

jobs:
  setup-rdp-tunnel:
    runs-on: windows-11-arm
    steps:
    - name: Check out the repository
      uses: actions/checkout@v2

    - name: Download and Install Bore
      run: |
        Write-Host "üì• –°–∫–∞—á–∏–≤–∞–µ–º Bore –¥–ª—è Windows..."
        Invoke-WebRequest -Uri "https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-pc-windows-msvc.zip" -OutFile "$env:USERPROFILE\bore.zip"
        
        Write-Host "üì¶ –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º Bore..."
        Expand-Archive -Path "$env:USERPROFILE\bore.zip" -DestinationPath "$env:USERPROFILE\bore" -Force
        
        Write-Host "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Bore..."
        Move-Item -Path "$env:USERPROFILE\bore\bore.exe" -Destination "$env:USERPROFILE\bore.exe" -Force
        
        Write-Host "‚úÖ Bore —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        Start-Sleep -Seconds 3

    - name: Enable Remote Desktop (RDP) and Sound with Full Settings
      run: |
        Write-Host "üñ•Ô∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º RDP —Å–µ—Ä–≤–µ—Ä..."
        
        # –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±—Ä–∞–Ω–¥–º–∞—É—ç—Ä–∞
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        New-NetFirewallRule -DisplayName "Allow RDP" -Direction Inbound -Protocol TCP -LocalPort 3389 -Action Allow
        
        # –í–∫–ª—é—á–µ–Ω–∏–µ –∑–≤—É–∫–∞
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "fDisableAudio" -Value 0
        Start-Service -Name "Audiosrv" -ErrorAction SilentlyContinue
        Set-Service -Name "Audiosrv" -StartupType Automatic -ErrorAction SilentlyContinue
        
        # –í–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤
        Start-Service -Name "TermService" -ErrorAction SilentlyContinue
        Set-Service -Name "TermService" -StartupType Automatic -ErrorAction SilentlyContinue
        gpupdate /force
        
        Write-Host "‚úÖ RDP –Ω–∞—Å—Ç—Ä–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ!"

    - name: Set RDP Password
      run: |
        Write-Host "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å –¥–ª—è RDP..."
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "Magisk2024!@#GitLab" -Force)
        Write-Host "‚úÖ –ü–∞—Ä–æ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    
    - name: System Setup
      run: |
        Write-Host "‚öôÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º—É..."
        New-Item -Path "$env:USERPROFILE\Downloads" -ItemType Directory -Force
        

        

        
        Write-Host "‚å®Ô∏è –î–æ–±–∞–≤–ª—è–µ–º —Ä—É—Å—Å–∫—É—é —Ä–∞—Å–∫–ª–∞–¥–∫—É..."
        try {
            Set-ItemProperty -Path "HKCU:\Keyboard Layout\Preload" -Name "1" -Value "00000409" -Type String -ErrorAction SilentlyContinue
            Set-ItemProperty -Path "HKCU:\Keyboard Layout\Substitutes" -Name "00000409" -Value "00000419" -Type String -ErrorAction SilentlyContinue
            Set-ItemProperty -Path "HKCU:\Keyboard Layout\Toggle" -Name "Hotkey" -Value "1" -Type String -ErrorAction SilentlyContinue
            Set-ItemProperty -Path "HKCU:\Keyboard Layout\Toggle" -Name "Language Hotkey" -Value "1" -Type String -ErrorAction SilentlyContinue
            Set-ItemProperty -Path "HKCU:\Keyboard Layout\Toggle" -Name "Layout Hotkey" -Value "3" -Type String -ErrorAction SilentlyContinue
        } catch {
            Write-Host "‚ö†Ô∏è –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å–∫–ª–∞–¥–∫–∏: $($_.Exception.Message)"
        }
        
        Write-Host "üé§ –í–∫–ª—é—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω..."
        try {
            Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\CapabilityAccessManager\ConsentStore\microphone" -Name "Value" -Value "Allow" -Type String -ErrorAction SilentlyContinue
        } catch {
            Write-Host "‚ö†Ô∏è –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: $($_.Exception.Message)"
        }
        
        Write-Host "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

    - name: Start Bore Tunnel and Keep Alive
      run: |
        Write-Host "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Bore —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è RDP..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ RDP —Ä–∞–±–æ—Ç–∞–µ—Ç
        $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
        if ($rdpService.Status -ne "Running") {
            Write-Host "‚ö†Ô∏è RDP —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º..."
            Start-Service -Name "TermService" -ErrorAction SilentlyContinue
        }
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º Bore —Ç—É–Ω–Ω–µ–ª—å –≤ —Ñ–æ–Ω–µ —Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –≤—ã–≤–æ–¥–∞
        Write-Host "üîó –°–æ–∑–¥–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å –Ω–∞ bore.pub..."
        $boreJob = Start-Job -ScriptBlock {
            & "$env:USERPROFILE\bore.exe" local 3389 --to bore.pub
        }
        
        Start-Sleep -Seconds 15
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å job
        $jobState = Get-Job -Id $boreJob.Id | Select-Object -ExpandProperty State
        if ($jobState -eq "Running") {
            Write-Host "‚úÖ Bore —Ç—É–Ω–Ω–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–µ!"
            
            # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –≤—ã–≤–æ–¥ –¥–ª—è –∞–¥—Ä–µ—Å–∞
            $jobOutput = Receive-Job -Id $boreJob.Id -Keep
            if ($jobOutput) {
                Write-Host "üìã –í—ã–≤–æ–¥ Bore:"
                $jobOutput | ForEach-Object { Write-Host $_ }
            }
        } else {
            Write-Host "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Bore job, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±..."
            
            # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Start-Process
            $boreProcess = Start-Process -FilePath "$env:USERPROFILE\bore.exe" -ArgumentList "local", "3389", "--to", "bore.pub" -WindowStyle Hidden -PassThru
            Start-Sleep -Seconds 10
            
            if ($boreProcess -and !$boreProcess.HasExited) {
                Write-Host "‚úÖ Bore –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ Start-Process!"
            }
        }
        
        # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        Write-Host ""
        Write-Host "=" * 50
        Write-Host "üìã –ò–ù–§–û–†–ú–ê–¶–ò–Ø –î–õ–Ø RDP –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø"
        Write-Host "=" * 50
        Write-Host "üë§ –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: runneradmin"
        Write-Host "üîê –ü–∞—Ä–æ–ª—å: Magisk2024!@#GitLab"
        Write-Host "ÔøΩ –õ–æ–∫–∞–æ–ª—å–Ω—ã–π –ø–æ—Ä—Ç: 3389"
        Write-Host "üåê –ü—É–±–ª–∏—á–Ω—ã–π –∞–¥—Ä–µ—Å: bore.pub:[—Å–ª—É—á–∞–π–Ω—ã–π_–ø–æ—Ä—Ç]"
        Write-Host "üí° –ê–¥—Ä–µ—Å –ø–æ–∫–∞–∑–∞–Ω –≤—ã—à–µ –≤ –ª–æ–≥–∞—Ö Bore"
        Write-Host "üñ•Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª—é–±–æ–π RDP –∫–ª–∏–µ–Ω—Ç –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
        Write-Host "=" * 50
        Write-Host ""
        
        Write-Host "‚è∞ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä–∞–±–æ—Ç—É —Ç—É–Ω–Ω–µ–ª—è..."
        Write-Host "üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–µ—Ä–≤–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ workflow"
        Write-Host "üìä –¢—É–Ω–Ω–µ–ª—å –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ ~6 —á–∞—Å–æ–≤"
        
        # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã
        $startTime = Get-Date
        $maxRunTime = New-TimeSpan -Hours 5 -Minutes 50
        $lastCheck = Get-Date
        
        while ((Get-Date) - $startTime -lt $maxRunTime) {
            try {
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
                if ((Get-Date) - $lastCheck -gt (New-TimeSpan -Minutes 2)) {
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º Bore job
                    $currentJobState = Get-Job -Id $boreJob.Id -ErrorAction SilentlyContinue | Select-Object -ExpandProperty State
                    if ($currentJobState -ne "Running") {
                        Write-Host "‚ö†Ô∏è Bore job –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º..."
                        Remove-Job -Id $boreJob.Id -Force -ErrorAction SilentlyContinue
                        
                        $boreJob = Start-Job -ScriptBlock {
                            & "$env:USERPROFILE\bore.exe" local 3389 --to bore.pub
                        }
                        Start-Sleep -Seconds 10
                        
                        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∞–¥—Ä–µ—Å
                        $newOutput = Receive-Job -Id $boreJob.Id -Keep
                        if ($newOutput) {
                            Write-Host "üîó –ù–æ–≤—ã–π –∞–¥—Ä–µ—Å Bore:"
                            $newOutput | ForEach-Object { Write-Host $_ }
                        }
                    }
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º RDP —Å–µ—Ä–≤–∏—Å
                    $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
                    if ($rdpService.Status -ne "Running") {
                        Write-Host "‚ö†Ô∏è RDP —Å–µ—Ä–≤–∏—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º..."
                        Start-Service -Name "TermService" -ErrorAction SilentlyContinue
                    }
                    
                    $lastCheck = Get-Date
                    Write-Host "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ - $(Get-Date -Format 'HH:mm:ss')"
                }
                
                Start-Sleep -Seconds 30
                
            } catch {
                Write-Host "‚ùå –û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: $($_.Exception.Message)"
                Start-Sleep -Seconds 60
            }
        }
        
        Write-Host "‚è∞ –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É..."
        Remove-Job -Id $boreJob.Id -Force -ErrorAction SilentlyContinue