name: Free Windows in Browser

on: workflow_dispatch

jobs:
  windows-vnc:
    runs-on: windows-2022
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install TightVNC Server
      run: |
        Write-Host "üì• –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º TightVNC..."
        Invoke-WebRequest -Uri "https://www.tightvnc.com/download/2.8.81/tightvnc-2.8.81-gpl-setup-64bit.msi" -OutFile "$env:TEMP\tightvnc.msi"
        Start-Process msiexec.exe -ArgumentList "/i `"$env:TEMP\tightvnc.msi`" /quiet /norestart" -Wait
        Write-Host "‚úÖ TightVNC —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."

    - name: Install noVNC
      run: |
        Write-Host "üì• –°–∫–∞—á–∏–≤–∞–µ–º noVNC..."
        Invoke-WebRequest -Uri "https://github.com/novnc/noVNC/archive/refs/heads/master.zip" -OutFile "$env:TEMP\novnc.zip"
        Expand-Archive -Path "$env:TEMP\novnc.zip" -DestinationPath "$env:USERPROFILE\novnc" -Force
        Write-Host "‚úÖ noVNC —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."

    - name: Install websockify
      run: |
        pip install websockify

    - name: Install cloudflared
      run: |
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "$env:USERPROFILE\cloudflared.exe"
        Write-Host "‚úÖ cloudflared —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."

    - name: Configure VNC Registry Settings
      run: |
        Write-Host "ÔøΩ –ù–∞—Å—Ç—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–µ–µ—Å—Ç—Ä –¥–ª—è TightVNC..."
        # –°–æ–∑–¥–∞–µ–º –∫–ª—é—á–∏ —Ä–µ–µ—Å—Ç—Ä–∞ –¥–ª—è TightVNC
        New-Item -Path "HKLM:\SOFTWARE\TightVNC" -Force
        New-Item -Path "HKLM:\SOFTWARE\TightVNC\Server" -Force
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã VNC —Å–µ—Ä–≤–µ—Ä–∞
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "RfbPort" -Value 5900 -Type DWord
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "AcceptRfbConnections" -Value 1 -Type DWord
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "LoopbackOnly" -Value 0 -Type DWord
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "AcceptHttpConnections" -Value 1 -Type DWord
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "HttpPort" -Value 5800 -Type DWord
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "UseAuthentication" -Value 1 -Type DWord
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å (—Ö–µ—à –¥–ª—è "123456")
        $password = [System.Text.Encoding]::ASCII.GetBytes("123456")
        $hash = [System.Security.Cryptography.MD5]::Create().ComputeHash($password)
        Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "Password" -Value $hash -Type Binary
        
        Write-Host "‚úÖ –†–µ–µ—Å—Ç—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω."

    - name: Start VNC + noVNC + Cloudflare Tunnel
      run: |
        Write-Host "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º VNC —Å–µ—Ä–≤–µ—Ä..."
        & "C:\Program Files\TightVNC\tvnserver.exe" -run

        Write-Host "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º websockify + noVNC..."
        $noVncPath = "$env:USERPROFILE\novnc\noVNC-master"
        Start-Process -NoNewWindow "python" -ArgumentList "-m", "websockify", "--web", $noVncPath, "6080", "localhost:5900"

        Start-Sleep -Seconds 5

        Write-Host "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Cloudflare Tunnel..."
        & "$env:USERPROFILE\cloudflared.exe" tunnel --url http://localhost:6080 | Tee-Object -FilePath cloudflared.log

    - name: Show Access URL
      run: |
        $log = Get-Content cloudflared.log | Select-String "https://.*trycloudflare.com" | Select-Object -First 1
        if ($log) {
          $url = $log.Matches[0].Value
          Write-Host "üåç –ü–µ—Ä–µ–π–¥–∏ –ø–æ —Å—Å—ã–ª–∫–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Windows:"
          Write-Host "$url/vnc.html?autoconnect=true&password=123456"
        } else {
          Write-Host "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å—Å—ã–ª–∫—É Cloudflare –≤ –ª–æ–≥–∞—Ö!"
        }
