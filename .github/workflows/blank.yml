name: Free Windows in Browser

on: workflow_dispatch

jobs:
  windows-vnc:
    runs-on: windows-2022
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install TightVNC Server
      run: |
        Write-Host "üì• –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º TightVNC..."
        Invoke-WebRequest -Uri "https://www.tightvnc.com/download/2.8.81/tightvnc-2.8.81-gpl-setup-64bit.msi" -OutFile "$env:TEMP\tightvnc.msi"
        Start-Process msiexec.exe -ArgumentList "/i `"$env:TEMP\tightvnc.msi`" /quiet /norestart" -Wait
        Write-Host "‚úÖ TightVNC —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."

    - name: Install noVNC
      run: |
        Write-Host "üì• –°–∫–∞—á–∏–≤–∞–µ–º noVNC..."
        Invoke-WebRequest -Uri "https://github.com/novnc/noVNC/archive/refs/heads/master.zip" -OutFile "$env:TEMP\novnc.zip"
        Expand-Archive -Path "$env:TEMP\novnc.zip" -DestinationPath "$env:USERPROFILE\novnc" -Force
        Write-Host "‚úÖ noVNC —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."

    - name: Install websockify
      run: |
        pip install websockify

    - name: Install cloudflared
      run: |
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "$env:USERPROFILE\cloudflared.exe"
        Write-Host "‚úÖ cloudflared —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."

    - name: Start VNC + noVNC + Cloudflare Tunnel
      run: |
        Write-Host "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º VNC —Å–µ—Ä–≤–µ—Ä..."
        & "C:\Program Files\TightVNC\tvnserver.exe" -controlapp -password 123456
        & "C:\Program Files\TightVNC\tvnserver.exe" -run

        Write-Host "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º noVNC..."
        Start-Process -NoNewWindow "python" -ArgumentList "$env:USERPROFILE\novnc\noVNC-master\utils\novnc_proxy", "--vnc", "localhost:5900", "--listen", "6080"

        Start-Sleep -Seconds 5

        Write-Host "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Cloudflare Tunnel..."
        & "$env:USERPROFILE\cloudflared.exe" tunnel --url http://localhost:6080
