name: Windows VNC Browser Access

on: workflow_dispatch

jobs:
  vnc-setup:
    runs-on: windows-latest
    steps:
    - name: Setup VNC Server
      run: |
        Write-Host "üì• –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º TightVNC..."
        Invoke-WebRequest -Uri "https://www.tightvnc.com/download/2.8.81/tightvnc-2.8.81-gpl-setup-64bit.msi" -OutFile "vnc.msi"
        Start-Process msiexec.exe -Wait -ArgumentList '/i vnc.msi /quiet /norestart ADDLOCAL="Server" SERVER_REGISTER_AS_SERVICE=1 SERVER_ADD_FIREWALL_EXCEPTION=1 SET_USEVNCAUTHENTICATION=1 VALUE_OF_USEVNCAUTHENTICATION=1 SET_PASSWORD=1 VALUE_OF_PASSWORD=123456'
        
        Write-Host "üñ•Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º VNC —Å–µ—Ä–≤–µ—Ä..."
        Start-Service tvnserver -ErrorAction SilentlyContinue

    - name: Setup noVNC
      run: |
        Write-Host "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º noVNC..."
        git clone https://github.com/novnc/noVNC.git C:\noVNC
        git clone https://github.com/novnc/websockify.git C:\websockify
        
        Write-Host "üêç –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
        pip install websockify

    - name: Setup Cloudflare Tunnel
      run: |
        Write-Host "‚òÅÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Cloudflared..."
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"

    - name: Start Services and Tunnel
      run: |
        Write-Host "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º websockify..."
        Start-Process python -ArgumentList "C:\websockify\websockify\websockify.py --web C:\noVNC 6080 localhost:5900" -WindowStyle Hidden
        
        Start-Sleep -Seconds 10
        
        Write-Host "üåê –°–æ–∑–¥–∞–µ–º Cloudflare —Ç—É–Ω–Ω–µ–ª—å..."
        $tunnel = Start-Process .\cloudflared.exe -ArgumentList "tunnel --url http://localhost:6080" -WindowStyle Hidden -PassThru -RedirectStandardOutput "tunnel.log"
        
        Start-Sleep -Seconds 15
        
        Write-Host "üìã –î–û–°–¢–£–ü –ö –†–ê–ë–û–ß–ï–ú–£ –°–¢–û–õ–£:"
        Write-Host "=" * 40
        if (Test-Path "tunnel.log") {
            $tunnelUrl = Get-Content "tunnel.log" | Select-String "https://.*\.trycloudflare\.com" | ForEach-Object { $_.Matches.Value }
            if ($tunnelUrl) {
                Write-Host "üåê URL: $tunnelUrl"
                Write-Host "üîê VNC –ø–∞—Ä–æ–ª—å: 123456"
            }
        }
        Write-Host "=" * 40
        
        Write-Host "‚è∞ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å –∞–∫—Ç–∏–≤–Ω—ã–º..."
        for ($i = 1; $i -le 300; $i++) {
            Start-Sleep -Seconds 60
            if ($i % 10 -eq 0) {
                Write-Host "‚úÖ –¢—É–Ω–Ω–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω - $i –º–∏–Ω—É—Ç"
            }
        }
