name: Windows VNC Browser Access

on: workflow_dispatch

jobs:
  vnc-setup:
    runs-on: windows-latest
    steps:
    - name: Enable RDP
      run: |
        Write-Host "ÔøΩÔ∏è–£ –í–∫–ª—é—á–∞–µ–º RDP..."
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "123456" -Force)

    - name: Setup noVNC
      run: |
        Write-Host "üì¶ –°–∫–∞—á–∏–≤–∞–µ–º noVNC..."
        Invoke-WebRequest -Uri "https://github.com/novnc/noVNC/archive/refs/heads/master.zip" -OutFile "novnc.zip"
        Expand-Archive -Path "novnc.zip" -DestinationPath "C:\" -Force
        Rename-Item "C:\noVNC-master" "C:\noVNC"
        
        Write-Host "üêç –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º websockify..."
        pip install websockify numpy

    - name: Setup Cloudflare Tunnel
      run: |
        Write-Host "‚òÅÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Cloudflared..."
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"

    - name: Start Services and Tunnel
      run: |
        Write-Host "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º websockify –¥–ª—è RDP..."
        Start-Job -ScriptBlock {
            websockify --web=C:\noVNC 6080 localhost:3389
        }
        
        Start-Sleep -Seconds 15
        
        Write-Host "üåê –°–æ–∑–¥–∞–µ–º Cloudflare —Ç—É–Ω–Ω–µ–ª—å..."
        $tunnel = Start-Process .\cloudflared.exe -ArgumentList "tunnel --url http://localhost:6080" -WindowStyle Hidden -PassThru -RedirectStandardOutput "tunnel.log"
        
        Start-Sleep -Seconds 20
        
        Write-Host "üìã –î–û–°–¢–£–ü –ö –†–ê–ë–û–ß–ï–ú–£ –°–¢–û–õ–£:"
        Write-Host "=" * 50
        if (Test-Path "tunnel.log") {
            $content = Get-Content "tunnel.log" -Raw
            if ($content -match "https://[^/\s]+\.trycloudflare\.com") {
                $tunnelUrl = $matches[0]
                Write-Host "üåê URL: $tunnelUrl"
                Write-Host "üë§ –õ–æ–≥–∏–Ω: runneradmin"  
                Write-Host "üîê –ü–∞—Ä–æ–ª—å: 123456"
                Write-Host "üí° –û—Ç–∫—Ä–æ–π—Ç–µ URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞–±–æ—á–µ–º—É —Å—Ç–æ–ª—É"
            } else {
                Write-Host "‚ö†Ô∏è URL –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ª–æ–≥–∞—Ö, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ tunnel.log"
                Get-Content "tunnel.log" | Write-Host
            }
        }
        Write-Host "=" * 50
        
        Write-Host "‚è∞ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å –∞–∫—Ç–∏–≤–Ω—ã–º..."
        for ($i = 1; $i -le 300; $i++) {
            Start-Sleep -Seconds 60
            if ($i % 5 -eq 0) {
                Write-Host "‚úÖ –¢—É–Ω–Ω–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω - $i –º–∏–Ω—É—Ç"
            }
        }
